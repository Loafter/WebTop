package main

import "fmt"
import "io/ioutil"
import "net/http"
import "strconv"
import "encoding/json"
import "encoding/base64"

const indexPageD = "PCFkb2N0eXBlIGh0bWw+DQo8aHRtbD4NCg0KPGhlYWQ+DQoJPHRpdGxlPldlYlRvcDwvdGl0bGU+DQoJPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCI+DQoJPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3Rzd2F0Y2gvMy4wLjAvc2xhdGUvYm9vdHN0cmFwLm1pbi5jc3MiPg0KCTxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vYWpheC5nb29nbGVhcGlzLmNvbS9hamF4L2xpYnMvanF1ZXJ5LzIuMC4zL2pxdWVyeS5taW4uanMiPjwvc2NyaXB0Pg0KCTxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMS4xL2pzL2Jvb3RzdHJhcC5taW4uanMiPjwvc2NyaXB0Pg0KCTxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHA6Ly9zbW9vdGhpZWNoYXJ0cy5vcmcvc21vb3RoaWUuanMiPjwvc2NyaXB0Pg0KCTxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+DQoJCS8qIFNwYWNlIG91dCBjb250ZW50IGEgYml0ICovDQoJCQ0KCQlib2R5IHsNCgkJCXBhZGRpbmctdG9wOiAyMHB4Ow0KCQkJcGFkZGluZy1ib3R0b206IDIwcHg7DQoJCX0NCgkJLyogRXZlcnl0aGluZyBidXQgdGhlIGp1bWJvdHJvbiBnZXRzIHNpZGUgc3BhY2luZyBmb3IgbW9iaWxlIGZpcnN0IHZpZXdzICovDQoJCQ0KCQkuaGVhZGVyLA0KCQkubWFya2V0aW5nLA0KCQkuZm9vdGVyIHsNCgkJCXBhZGRpbmctbGVmdDogMTVweDsNCgkJCXBhZGRpbmctcmlnaHQ6IDE1cHg7DQoJCX0NCgkJLyogQ3VzdG9tIHBhZ2UgaGVhZGVyICovDQoJCQ0KCQkuaGVhZGVyIHsNCgkJCWJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZTVlNWU1Ow0KCQl9DQoJCS8qIE1ha2UgdGhlIG1hc3RoZWFkIGhlYWRpbmcgdGhlIHNhbWUgaGVpZ2h0IGFzIHRoZSBuYXZpZ2F0aW9uICovDQoJCQ0KCQkuaGVhZGVyIGgzIHsNCgkJCW1hcmdpbi10b3A6IDA7DQoJCQltYXJnaW4tYm90dG9tOiAwOw0KCQkJbGluZS1oZWlnaHQ6IDQwcHg7DQoJCQlwYWRkaW5nLWJvdHRvbTogMTlweDsNCgkJfQ0KCQkvKiBDdXN0b20gcGFnZSBmb290ZXIgKi8NCgkJDQoJCS5mb290ZXIgew0KCQkJcGFkZGluZy10b3A6IDE5cHg7DQoJCQljb2xvcjogIzc3NzsNCgkJCWJvcmRlci10b3A6IDFweCBzb2xpZCAjZTVlNWU1Ow0KCQl9DQoJCS8qIEN1c3RvbWl6ZSBjb250YWluZXIgKi8NCgkJDQoJCUBtZWRpYShtaW4td2lkdGg6IDc2OHB4KSB7DQoJCQkuY29udGFpbmVyIHsNCgkJCQltYXgtd2lkdGg6IDczMHB4Ow0KCQkJfQ0KCQl9DQoJCS5jb250YWluZXItbmFycm93ID4gaHIgew0KCQkJbWFyZ2luOiAzMHB4IDA7DQoJCX0NCgkJLyogTWFpbiBtYXJrZXRpbmcgbWVzc2FnZSBhbmQgc2lnbiB1cCBidXR0b24gKi8NCgkJDQoJCS5qdW1ib3Ryb24gew0KCQkJdGV4dC1hbGlnbjogY2VudGVyOw0KCQkJYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNlNWU1ZTU7DQoJCX0NCgkJLmp1bWJvdHJvbiAuYnRuIHsNCgkJCWZvbnQtc2l6ZTogMjFweDsNCgkJCXBhZGRpbmc6IDE0cHggMjRweDsNCgkJfQ0KCQkvKiBTdXBwb3J0aW5nIG1hcmtldGluZyBjb250ZW50ICovDQoJCQ0KCQkubWFya2V0aW5nIHsNCgkJCW1hcmdpbjogNDBweCAwOw0KCQl9DQoJCS5tYXJrZXRpbmcgcCArIGg0IHsNCgkJCW1hcmdpbi10b3A6IDI4cHg7DQoJCX0NCgkJLyogUmVzcG9uc2l2ZTogUG9ydHJhaXQgdGFibGV0cyBhbmQgdXAgKi8NCgkJDQoJCUBtZWRpYSBzY3JlZW4gYW5kKG1pbi13aWR0aDogNzY4cHgpIHsNCgkJCS8qIFJlbW92ZSB0aGUgcGFkZGluZyB3ZSBzZXQgZWFybGllciAqLw0KCQkJDQoJCQkuaGVhZGVyLA0KCQkJLm1hcmtldGluZywNCgkJCS5mb290ZXIgew0KCQkJCXBhZGRpbmctbGVmdDogMDsNCgkJCQlwYWRkaW5nLXJpZ2h0OiAwOw0KCQkJfQ0KCQkJLyogU3BhY2Ugb3V0IHRoZSBtYXN0aGVhZCAqLw0KCQkJDQoJCQkuaGVhZGVyIHsNCgkJCQltYXJnaW4tYm90dG9tOiAzMHB4Ow0KCQkJfQ0KCQkJLyogUmVtb3ZlIHRoZSBib3R0b20gYm9yZGVyIG9uIHRoZSBqdW1ib3Ryb24gZm9yIHZpc3VhbCBlZmZlY3QgKi8NCgkJCQ0KCQkJLmp1bWJvdHJvbiB7DQoJCQkJYm9yZGVyLWJvdHRvbTogMDsNCgkJCX0NCgkJfQ0KCQlzcGFuLnRhYiB7DQoJCQlmbG9hdDogcmlnaHQNCgkJfQ0KCTwvc3R5bGU+DQoJPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiPg0KCQl2YXIgbGFzdFRvcERhdGEgPSB7fTsNCgkJdmFyIG1pbkNwdVVzYWdlID0gMC4wMDAwMDENCgkJdmFyIGNwdURhdGEgPSBuZXcgVGltZVNlcmllcygpOw0KCQl2YXIgbWVtRGF0YSA9IG5ldyBUaW1lU2VyaWVzKCk7DQoNCgkJZnVuY3Rpb24gY3JlYXRlVGltZWxpbmUoKSB7DQoJCQl2YXIgY2hhcnQgPSBuZXcgU21vb3RoaWVDaGFydCh7DQoJCQkJbWF4VmFsdWU6IDEwMCwNCgkJCQltaW5WYWx1ZTogMCwNCgkJCQltaWxsaXNQZXJQaXhlbDogMTAwLA0KCQkJCWdyaWQ6IHsNCgkJCQkJZmlsbFN0eWxlOiAnIzNlNDQ0YycNCgkJCQl9DQoJCQl9KTsNCgkJCWNoYXJ0LmFkZFRpbWVTZXJpZXMoY3B1RGF0YSwgew0KCQkJCWxpbmVXaWR0aDogMiwNCgkJCQlzdHJva2VTdHlsZTogJyNhMGFmYzMnLA0KCQkJCWZpbGxTdHlsZTogJ3JnYmEoMTEyLDEyNywxNDYsMC4zMCknDQoJCQl9KTsNCgkJCWNoYXJ0LmFkZFRpbWVTZXJpZXMobWVtRGF0YSwgew0KCQkJCWxpbmVXaWR0aDogMiwNCgkJCQlzdHJva2VTdHlsZTogJyNiMGFmYzMnLA0KCQkJCWZpbGxTdHlsZTogJ3JnYmEoMjEyLDEyNywxNDYsMC4zMCknDQoJCQl9KTsNCgkJCWNoYXJ0LnN0cmVhbVRvKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjcHUtbWVtLWNoYXJ0IikpOw0KCQl9DQoNCgkJZnVuY3Rpb24gdXBkYXRlQ2hhcnQoKSB7DQoJCQl2YXIgbGFzdENwdURhdGEgPSB7DQoJCQkJVG90YWw6IDAsDQoJCQkJSWRsZTogMA0KCQkJfTsNCgkJCSQuYWpheCh7DQoJCQkJdXJsOiAiL3dlYnRvcCIsDQoJCQkJdHlwZTogIlBPU1QiLA0KCQkJCWRhdGE6ICd7XCJUeXBlXCI6IFwiMVwifScsDQoJCQkJZGF0YVR5cGU6ICJqc29uIg0KCQkJfSkuZG9uZShmdW5jdGlvbihqc29uRGF0YSkgew0KCQkJCXZhciBjcHVMb2FkID0ganNvbkRhdGEuQ1BVVXNhZ2UuVXNlclBjdDsNCgkJCQl2YXIgTWVtTG9hZCA9ICgoanNvbkRhdGEuTWVtU2FtcGxlLk1lbVVzZWQpIC8ganNvbkRhdGEuTWVtU2FtcGxlLk1lbVRvdGFsKSAqIDEwMDsNCgkJCQlsYXN0Q3B1RGF0YSA9IGpzb25EYXRhLkNwdVNhbXBsZTsNCgkJCQljcHVEYXRhLmFwcGVuZChuZXcgRGF0ZSgpLmdldFRpbWUoKSwgY3B1TG9hZCk7DQoJCQkJbWVtRGF0YS5hcHBlbmQobmV3IERhdGUoKS5nZXRUaW1lKCksIE1lbUxvYWQpOw0KCQkJfSkNCgkJfQ0KDQoJCWZ1bmN0aW9uIHVwZGF0ZVN0YXRpc3RpYygpIHsNCgkJCXZhciBsYXN0Q3B1RGF0YSA9IHsNCgkJCQlUb3RhbDogMCwNCgkJCQlJZGxlOiAwDQoJCQl9Ow0KCQkJJC5hamF4KHsNCgkJCQl1cmw6ICIvd2VidG9wIiwNCgkJCQl0eXBlOiAiUE9TVCIsDQoJCQkJZGF0YTogJ3tcIlR5cGVcIjogXCIxXCJ9JywNCgkJCQlkYXRhVHlwZTogImpzb24iDQoJCQl9KS5kb25lKGZ1bmN0aW9uKGpzb25EYXRhKSB7DQoJCQkJLy9jcHUgdGFibGUNCgkJCQkkKCIjdXNlci1sb2FkLWNwdSIpLnRleHQoanNvbkRhdGEuQ1BVVXNhZ2UuVXNlclBjdC50b0ZpeGVkKDEpICsgJyAlJyk7DQoJCQkJJCgiI3N5c3RlbS1sb2FkLWNwdSIpLnRleHQoanNvbkRhdGEuQ1BVVXNhZ2UuU3lzdGVtUGN0LnRvRml4ZWQoMSkgKyAnICUnKTsNCgkJCQkkKCIjaWRsZS1sb2FkLWNwdSIpLnRleHQoanNvbkRhdGEuQ1BVVXNhZ2UuSWRsZVBjdC50b0ZpeGVkKDEpICsgJyAlJyk7DQoJCQkJJCgiI2d1ZXN0LWxvYWQtY3B1IikudGV4dChqc29uRGF0YS5DUFVVc2FnZS5HdWVzdFBjdC50b0ZpeGVkKDEpICsgJyAlJyk7DQoJCQkJJCgiI2xvdy1sb2FkLWNwdSIpLnRleHQoanNvbkRhdGEuQ1BVVXNhZ2UuSW93YWl0UGN0LnRvRml4ZWQoMSkgKyAnICUnKTsNCgkJCQkvL21lbSB0YWJsZQkNCgkJCQkkKCIjYnVmZmVycy1tZW0iKS50ZXh0KChqc29uRGF0YS5NZW1TYW1wbGUuQnVmZmVycyAqIDAuMDAwOTc2NTYyKS50b0ZpeGVkKDEpICsgJyBNYicpDQoJCQkJJCgiI3VzZWQtbWVtIikudGV4dCgoanNvbkRhdGEuTWVtU2FtcGxlLk1lbVVzZWQgKiAwLjAwMDk3NjU2MikudG9GaXhlZCgxKSArICcgTWInKQ0KCQkJCSQoIiNmcmVlLW1lbSIpLnRleHQoKGpzb25EYXRhLk1lbVNhbXBsZS5NZW1GcmVlICogMC4wMDA5NzY1NjIpLnRvRml4ZWQoMSkgKyAnIE1iJykNCgkJCQkkKCIjdG90YWwtbWVtIikudGV4dCgoanNvbkRhdGEuTWVtU2FtcGxlLk1lbVRvdGFsICogMC4wMDA5NzY1NjIpLnRvRml4ZWQoMSkgKyAnIE1iJykNCgkJCQkkKCIjY2FjaGVkLW1lbSIpLnRleHQoKGpzb25EYXRhLk1lbVNhbXBsZS5DYWNoZWQgKiAwLjAwMDk3NjU2MikudG9GaXhlZCgxKSArICcgTWInKQ0KCQkJfSkNCgkJfQ0KDQoJCWZ1bmN0aW9uIGFkZFByb2Nlc3NUb1RhYmxlKHByb2Nlc3NJbmZvKSB7DQoJCQlwaWQgPSBwcm9jZXNzSW5mby5QaWQNCgkJCU5hbWUgPSBwcm9jZXNzSW5mby5OYW1lDQoJCQlVc2VyID0gcHJvY2Vzc0luZm8uVXNlcg0KCQkJQ3B1ID0gcHJvY2Vzc0luZm8uQ3B1LnRvRml4ZWQoMSkNCgkJCU1lbSA9IChwcm9jZXNzSW5mby5NZW1vcnkgKiAwLjAwMDk3NjU2MikudG9GaXhlZCgxKQ0KCQkJaW5lckh0bWwgPSAiIg0KCQkJaW5lckh0bWwgPSBpbmVySHRtbC5jb25jYXQoJzx0ciBvbmNsaWNrPSJvbkNsaWNrS2lsbCh0aGlzKSIgaWQ9InByLWl0ZW1zJyArIHBpZCArICciPjx0ZCBpZD0icGlkJyArIHBpZCArICciPicgKyBwaWQgKyAnPC90ZD48dGQgaWQ9Im5hbWUtaWQnICsgcGlkICsgJyI+JyArIE5hbWUgKyAnPC90ZD48dGQgaWQ9InVzZXItaWQnICsgcGlkICsgJyI+JyArIFVzZXIgKyAnPC90ZD48dGQgaWQ9ImNwdS1pZCcgKyBwaWQgKyAnIj4nICsgQ3B1ICsgJzwvdGQ+PHRkIGlkPSJtZW1vcnktaWQnICsgcGlkICsgJyI+JyArIE1lbSArICc8L3RkPjwvdHI+JykNCgkJCSQoIiNwcm9jZXNzLWxpc3QtdGFibGUiKS5hcHBlbmQoaW5lckh0bWwpDQoJCX0NCg0KCQlmdW5jdGlvbiB1cGRhdGVQcm9jZXNzSW5UYWJsZShwcm9jZXNzSW5mbykgew0KCQkJcGlkID0gcHJvY2Vzc0luZm8uUGlkDQoJCQlOYW1lID0gcHJvY2Vzc0luZm8uTmFtZQ0KCQkJVXNlciA9IHByb2Nlc3NJbmZvLlVzZXINCgkJCUNwdSA9IChwcm9jZXNzSW5mby5DcHUgKiAxMDApLnRvRml4ZWQoMSkNCgkJCU1lbW9yeSA9IChwcm9jZXNzSW5mby5NZW1vcnkgKiAwLjAwMDk3NjU2MikudG9GaXhlZCgxKQ0KCQkJJCgiI3BpZCIgKyBwaWQpLnRleHQocGlkKQ0KCQkJJCgiI25hbWUtaWQiICsgcGlkKS50ZXh0KE5hbWUpDQoJCQkkKCIjdXNlci1pZCIgKyBwaWQpLnRleHQoVXNlcikNCgkJCSQoIiNjcHUtaWQiICsgcGlkKS50ZXh0KENwdSkNCgkJCSQoIiNtZW1vcnktaWQiICsgcGlkKS50ZXh0KE1lbW9yeSkNCgkJfQ0KDQoJCWZ1bmN0aW9uIGRlbGV0ZVByb2Nlc3NGcm9tVGFibGUocGlkKSB7DQoJCQlyb3dJZCA9ICIjcHItaXRlbXMiICsgcGlkDQoJCQkkKHJvd0lkKS5yZW1vdmUoKQ0KCQl9DQoNCgkJZnVuY3Rpb24gdXBkYXRlVG9wKCkgew0KCQkJJC5hamF4KHsNCgkJCQl1cmw6ICIvd2VidG9wIiwNCgkJCQl0eXBlOiAiUE9TVCIsDQoJCQkJZGF0YTogJ3tcIlR5cGVcIjogXCIyXCJ9JywNCgkJCQlkYXRhVHlwZTogImpzb24iDQoJCQl9KS5kb25lKGZ1bmN0aW9uKGpzb25EYXRhKSB7DQoJCQkJdmFyIHRvcERpYyA9IHt9Ow0KCQkJCWZvciAoaW5kZXggaW4ganNvbkRhdGEuUHJvY2Vzc0l0ZW1zKSB7DQoJCQkJCXRvcEl0ZW1zID0ganNvbkRhdGEuUHJvY2Vzc0l0ZW1zW2luZGV4XQ0KCQkJCQlpZiAobWluQ3B1VXNhZ2UgPD0gdG9wSXRlbXMuQ3B1KSB7DQoJCQkJCQl0b3BEaWNbdG9wSXRlbXMuUGlkXSA9IHRvcEl0ZW1zOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCWNvbnNvbGUubG9nKCJfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXyIpDQoJCQkJaWYgKE9iamVjdC5rZXlzKGxhc3RUb3BEYXRhKS5sZW5ndGggPT0gMCkgew0KCQkJCQlsYXN0VG9wRGF0YSA9IHRvcERpYw0KCQkJCQljb25zb2xlLmxvZygiZnVsbCBuZXcgdGFibGUiKQ0KCQkJCQlmb3IgKGluZGV4IGluIHRvcERpYykgew0KCQkJCQkJYWRkUHJvY2Vzc1RvVGFibGUodG9wRGljW2luZGV4XSkNCgkJCQkJfQ0KCQkJCX0gZWxzZSB7DQoJCQkJCWl0ZW1zZm9yUmVtb3ZlID0gbGFzdFRvcERhdGENCgkJCQkJZm9yIChpbmRleCBpbiB0b3BEaWMpIHsNCgkJCQkJCXBpZCA9IHRvcERpY1tpbmRleF0uUGlkDQoJCQkJCQlpZiAoIShsYXN0VG9wRGF0YVtwaWRdID09PSB1bmRlZmluZWQpKSB7DQoJCQkJCQkJY29uc29sZS5sb2coInVwZGF0ZWQgIiArIEpTT04uc3RyaW5naWZ5KHRvcERpY1tpbmRleF0uUGlkKSkNCgkJCQkJCQl1cGRhdGVQcm9jZXNzSW5UYWJsZSh0b3BEaWNbaW5kZXhdKQ0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQljb25zb2xlLmxvZygiYWRkZWQgIiArIEpTT04uc3RyaW5naWZ5KHRvcERpY1tpbmRleF0uUGlkKSkNCgkJCQkJCQlhZGRQcm9jZXNzVG9UYWJsZSh0b3BEaWNbaW5kZXhdKQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCWZvciAoaW5kZXggaW4gaXRlbXNmb3JSZW1vdmUpIHsNCgkJCQkJCWlmICgodG9wRGljW2luZGV4XSA9PT0gdW5kZWZpbmVkKSkgew0KCQkJCQkJCWNvbnNvbGUubG9nKCJkZWxldGVkICIgKyBKU09OLnN0cmluZ2lmeShpdGVtc2ZvclJlbW92ZVtpbmRleF0uUGlkKSkNCgkJCQkJCQlkZWxldGVQcm9jZXNzRnJvbVRhYmxlKGl0ZW1zZm9yUmVtb3ZlW2luZGV4XS5QaWQpDQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQkJbGFzdFRvcERhdGEgPSB0b3BEaWMNCgkJCX0pDQoJCX0NCg0KCQlmdW5jdGlvbiBvbkRvY3VtZW50TG9hZCgpIHsNCgkJCWNyZWF0ZVRpbWVsaW5lKCkNCgkJCXNldEludGVydmFsKHVwZGF0ZUNoYXJ0LCA1MDApOw0KCQkJc2V0SW50ZXJ2YWwodXBkYXRlU3RhdGlzdGljLCA3MDApOw0KCQkJc2V0SW50ZXJ2YWwodXBkYXRlVG9wLCA3MDApDQoJCX0NCg0KCQlmdW5jdGlvbiBvbkNsaWNrS2lsbChlKSB7DQoJCQlwaWQgPSBlLmlkLnN1YnN0cmluZyg4KQ0KCQkJJC5hamF4KHsNCgkJCQl1cmw6ICIvd2VidG9wIiwNCgkJCQl0eXBlOiAiUE9TVCIsDQoJCQkJZGF0YTogJ3tcIlR5cGVcIjogXCIzXCIsXCJQaWQiOiAnICsgcGlkICsgJ30nLA0KCQkJCWRhdGFUeXBlOiAianNvbiINCgkJCX0pDQoJCX0NCg0KCQlmdW5jdGlvbiBzd2l0Y2hVc2FnZSgpIHsNCgkJCWlmIChtaW5DcHVVc2FnZSA9PSAwLjApIHsNCgkJCQltaW5DcHVVc2FnZSA9IDAuMDAwMDAxDQoJCQkJJCgiI2NwdS1taW51bSIpLnRleHQoIj4wIikNCgkJCX0gZWxzZSBpZiAobWluQ3B1VXNhZ2UgPT0gMC4wMDAwMDEpIHsNCgkJCQltaW5DcHVVc2FnZSA9IDAuMjUNCgkJCQkkKCIjY3B1LW1pbnVtIikudGV4dCgiPjI1IikNCgkJCX0gZWxzZSBpZiAobWluQ3B1VXNhZ2UgPT0gMC4yNSkgew0KCQkJCW1pbkNwdVVzYWdlID0gMC41DQoJCQkJJCgiI2NwdS1taW51bSIpLnRleHQoIj41MCIpDQoJCQl9IGVsc2UgaWYgKG1pbkNwdVVzYWdlID09IDAuNSkgew0KCQkJCW1pbkNwdVVzYWdlID0gMC43NQ0KCQkJCSQoIiNjcHUtbWludW0iKS50ZXh0KCI+NzUiKQ0KCQkJfSBlbHNlIGlmIChtaW5DcHVVc2FnZSA9PSAwLjc1KSB7DQoJCQkJbWluQ3B1VXNhZ2UgPSAwDQoJCQkJJCgiI2NwdS1taW51bSIpLnRleHQoIj49MCIpDQoJCQl9DQoJCX0NCgk8L3NjcmlwdD4NCjwvaGVhZD4NCg0KPGJvZHkgb25sb2FkPSJvbkRvY3VtZW50TG9hZCgpIj4NCgk8ZGl2IGNsYXNzPSJjb250YWluZXIiPg0KCQk8aDE+V2ViVG9wIHN5c3RlbSBtb25pdG9yPC9oMT4NCgkJPGRpdiBjbGFzcz0icGFuZWwtZm9vdGVyIj5TeXN0ZW0gc3RhdGUgPC9kaXY+DQoJCTxkaXYgY2xhc3M9InBhbmVsLWJvZHkiIGRhdGEtZHMtZWRpdG1hcms9InRydWUiPg0KCQkJPGRpdiBjbGFzcz0icm93Ij4NCgkJCQk8ZGl2IGNsYXNzPSJjb2wtbWQtNCI+IDxzcGFuIGNsYXNzPSJsYWJlbCBsYWJlbC1kZWZhdWx0Ij5DcHUgbG9hZDwvc3Bhbj4NCgkJCQkJPHA+VXNlcjo8c3BhbiBjbGFzcz0idGFiIiBpZD0idXNlci1sb2FkLWNwdSI+MTAlPC9zcGFuPiA8L3A+DQoJCQkJCTxwPlN5c3RlbTo8c3BhbiBjbGFzcz0idGFiIiBpZD0ic3lzdGVtLWxvYWQtY3B1Ij4xMCU8L3NwYW4+IDwvcD4NCgkJCQkJPHA+SWRsZTo8c3BhbiBjbGFzcz0idGFiIiBpZD0iaWRsZS1sb2FkLWNwdSI+MTAlPC9zcGFuPiA8L3A+DQoJCQkJCTxwPkd1ZXN0OjxzcGFuIGNsYXNzPSJ0YWIiIGlkPSJndWVzdC1sb2FkLWNwdSI+MTAlPC9zcGFuPiA8L3A+DQoJCQkJCTxwPkxvdzo8c3BhbiBjbGFzcz0idGFiIiBpZD0ibG93LWxvYWQtY3B1Ij4xMCU8L3NwYW4+IDwvcD4NCgkJCQk8L2Rpdj4NCgkJCQk8ZGl2IGNsYXNzPSJjb2wtbWQtNCI+IDxzcGFuIGNsYXNzPSJsYWJlbCBsYWJlbC1kZWZhdWx0Ij5TeXN0ZW0gaW5mbzwvc3Bhbj4NCgkJCQkJPHA+TWVtb3J5IHVzZWQ6PHNwYW4gY2xhc3M9InRhYiIgaWQ9InVzZWQtbWVtIj4xMCU8L3NwYW4+IDwvcD4NCgkJCQkJPHA+TWVtb3J5IGZyZWU6PHNwYW4gY2xhc3M9InRhYiIgaWQ9ImZyZWUtbWVtIj4xMCU8L3NwYW4+IDwvcD4NCgkJCQkJPHA+QnVmZmVyczo8c3BhbiBjbGFzcz0idGFiIiBpZD0iYnVmZmVycy1tZW0iPjEwJTwvc3Bhbj4gPC9wPg0KCQkJCQk8cD5DYWNoZWQ6PHNwYW4gY2xhc3M9InRhYiIgaWQ9ImNhY2hlZC1tZW0iPjEwJTwvc3Bhbj4gPC9wPg0KCQkJCQk8cD5NZW1vcnkgdG90YWw6PHNwYW4gY2xhc3M9InRhYiIgaWQ9InRvdGFsLW1lbSI+MTAlPC9zcGFuPiA8L3A+DQoJCQkJPC9kaXY+DQoJCQkJPGRpdiBjbGFzcz0iY29sLW1kLTQiPiA8c3BhbiBjbGFzcz0ibGFiZWwgbGFiZWwtZGVmYXVsdCI+Q3B1IGdyYXBoPC9zcGFuPiA8c3BhbiBjbGFzcz0idGFiIj4gPGNhbnZhcyBpZD0iY3B1LW1lbS1jaGFydCIgd2lkdGg9IjIxOCIgaGVpZ2h0PSIxMzgiPjwvY2FudmFzPjwvc3Bhbj4gPC9kaXY+DQoJCQk8L2Rpdj4NCgkJPC9kaXY+DQoJCTxkaXYgY2xhc3M9InBhbmVsLWZvb3RlciI+UHJvY2VzcyBsaXN0IDwvZGl2Pg0KCQk8dGFibGUgY2xhc3M9InRhYmxlIHRhYmxlLWJvcmRlcmVkIHRhYmxlLWNvbmRlbnNlZCB0YWJsZS1ob3ZlciB0YWJsZS1zdHJpcGVkIj4NCgkJCTx0aGVhZD4NCgkJCQk8dHI+DQoJCQkJCTx0aD5QaWQ8L3RoPg0KCQkJCQk8dGg+UHJvY2VzcyBuYW1lPC90aD4NCgkJCQkJPHRoPlVzZXIgaWQ8L3RoPg0KCQkJCQk8dGg+Q3B1IDxzcGFuIG9uY2xpY2s9InN3aXRjaFVzYWdlKCkiIGlkPSJjcHUtbWludW0iPj49MDwvc3Bhbj4lPC90aD4NCgkJCQkJPHRoPk1lbSBNYi48L3RoPg0KCQkJCTwvdHI+DQoJCQk8L3RoZWFkPg0KCQkJPHRib2R5IGlkPSJwcm9jZXNzLWxpc3QtdGFibGUiPiA8L3Rib2R5Pg0KCQk8L3RhYmxlPg0KCQk8ZGl2IGNsYXNzPSJwYW5lbC1ib2R5IiBkYXRhLWRzLWVkaXRtYXJrPSJ0cnVlIj48L2Rpdj4NCgk8L2Rpdj4NCjwvYm9keT4="

//main service class
type TopJsonService struct {
	requestSelector RequestSelector
	jsonFabric      JsonFabric
}

//start and init service
func (serviceState *TopJsonService) Start(listenPort int) error {
	serviceState.requestSelector = RequestSelector{}
	serviceState.requestSelector.Init()
	fmt.Println(":" + strconv.Itoa(listenPort))
	http.HandleFunc("/webtop", serviceState.ServeHTTP)
	http.HandleFunc("/index.html", serviceState.ServePage)
	http.HandleFunc("/samplejson", serviceState.ReturnDummyReq)
	retVal := http.ListenAndServe(":"+strconv.Itoa(listenPort), nil)
	return retVal
}

//serve http responce in different thread
func (service *TopJsonService) ServeHTTP(responseWriter http.ResponseWriter, request *http.Request) {
	if reqData, err := service.jsonFabric.ProduceJsonRequest(request); err != nil {
		http.Error(responseWriter, err.Error(), http.StatusInternalServerError)
	} else {
		service.requestSelector.Dispatch(reqData, responseWriter, request)
	}

}

//serve main page request
func (service *TopJsonService) ServePage(responseWriter http.ResponseWriter, request *http.Request) {
	responseWriter.Header().Set("Content-Type: text/html", "*")
	content, err := ioutil.ReadFile("index.html")
	if err != nil {
		val, _ := base64.StdEncoding.DecodeString(indexPageD)
		responseWriter.Write(val)
		return
	}
	responseWriter.Write(content)
}

func (service *TopJsonService) ReturnDummyReq(responseWriter http.ResponseWriter, request *http.Request) {
	//this is service is not need lock
	serviceState := KillRequest{BasicRequest{6}, 87}
	js, err := json.Marshal(serviceState)
	if err != nil {
		http.Error(responseWriter, err.Error(), http.StatusInternalServerError)
		return
	}
	responseWriter.Header().Set("Content-Type", "application/json")
	responseWriter.Write(js)
	return

}
